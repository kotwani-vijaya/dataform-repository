config {
    type: "incremental",
    uniqueKey: ["sale_date", "product_id"]
}

SELECT
  DATE(order_date) AS sale_date,
  product_id,
  SUM(quantity) AS total_quantity,
  SUM(quantity * unit_price) AS total_revenue
FROM
  ${ref("raw_sales")}
WHERE
  order_date > ${when(incremental(), `(SELECT MAX(sale_date) FROM ${self()})`, `DATE('2000-01-01')`)}
GROUP BY
  sale_date,
  product_id
